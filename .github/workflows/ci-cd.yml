name: mock CI/CD

on:
  workflow_dispatch: 
  push:
    branches:
      - 'feature/*'
    paths:
      - alpha/**
      - beta/**
      - gamma/**
  pull_request:
    branches:
      - 'release/*'
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch full history

    - name: Find the first commit of the branch
      run: |
        # Find the first commit on the current branch by using git merge-base with the parent branch (main)
        FIRST_COMMIT=$(git rev-list --boundary HEAD...origin/main | grep "^-" | head -n 1 | sed 's/^-//')
        echo "FIRST_COMMIT=$FIRST_COMMIT" >> $GITHUB_ENV

    - name: List all modified files in the branch
      id: changed_files
      run: |
        echo "The following files were modified in this branch:"
        MODIFIED_FILES=$(git diff --name-only $FIRST_COMMIT ${{ github.sha }})
        echo "$MODIFIED_FILES"
        echo "$MODIFIED_FILES" | tr '\n' ',' > files_list.txt  # Save file list as a comma-separated string to a file
        echo "MODIFIED_FILES=$(cat files_list.txt)" >> $GITHUB_ENV  # Write the comma-separated list to the environment variable

    - name: Create directory for modified folders
      run: mkdir -p modified_folders  # Create a directory to store the modified folders

    - name: Copy modified folders to the root of the zip
      run: |
        for file in $(echo $MODIFIED_FILES | tr ',' '\n'); do
          # Extract the folder path from the file path
          folder=$(dirname "$file")
          # Create the necessary directory structure inside the modified_folders directory
          mkdir -p "modified_folders/$folder"
          # Copy the modified file to the appropriate folder
          cp "$file" "modified_folders/$folder"
        done

    - name: Create zip archive of modified folders
      run: |
        cd modified_folders && zip -r ../modified_folders.zip .  # Create a zip archive of the modified folders

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: modified-folders-archive
        path: modified_folders.zip
